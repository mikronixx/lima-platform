---
- name: Configure prerequisites on all nodes
  hosts: all
  become: true
  vars_files:
    - vars.yml
  roles:
    - k8s_prereqs

- name: Initialize control plane
  hosts: control_plane
  become: true
  vars_files:
    - vars.yml
  roles:
    - kubeadm_control_plane

- name: Join workers to cluster
  hosts: workers
  become: true
  vars_files:
    - vars.yml
  roles:
    - kubeadm_workers

- name: Approve kubelet-serving CSRs
  hosts: control_plane
  become: false
  tasks:
    - name: Wait for CSR creation
      ansible.builtin.pause:
        seconds: 90

    - name: Approve all pending CSRs
      ansible.builtin.shell: |
        set -euo pipefail
        for a in $(kubectl get csr -o name); do
          kubectl certificate approve "$a";
        done
      args:
        executable: /bin/bash